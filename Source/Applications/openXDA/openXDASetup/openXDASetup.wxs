<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi" xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">
  <Product Id="{FFB0D815-060F-4FC5-B8A7-957E9F31D752}" Name="openXDA" Language="1033" Version="!(bind.FileVersion.openXDA.exe)" Manufacturer="Grid Protection Alliance" UpgradeCode="{EDB9D2AA-F21E-475F-9782-E2C95BF072C0}">
    <Package InstallerVersion="200" Compressed="yes" InstallScope="perMachine" />

    <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />
    <MediaTemplate EmbedCab="yes" />

    <PropertyRef Id="WIX_IS_NETFRAMEWORK_46_OR_LATER_INSTALLED"/>
    <Condition Message='This setup requires Microsoft .NET Framework 4.6 or greater - this will need to be installed before installation can continue.'>
      <![CDATA[Installed OR WIX_IS_NETFRAMEWORK_46_OR_LATER_INSTALLED]]>
    </Condition>

    <Feature Id="AllProducts" Title="All Products" Level="1" Display="expand" ConfigurableDirectory="INSTALLFOLDER" AllowAdvertise="no" Description="All components of the openXDA installation.">
      <!-- openXDA Database-->
      <Feature Id="DatabaseFeature" Title="openXDA Database" AllowAdvertise="no" Description="Installs the openXDA database schema to a SQL Server database.">
        <ComponentGroupRef Id="DatabaseComponents" />
      </Feature>
      
      <!-- openXDA Service -->
      <Feature Id="ServiceFeature" Title="openXDA Service" AllowAdvertise="no" Description="Installs the openXDA Windows service to perform data analytics.">
        <ComponentGroupRef Id="ServiceComponents" />

        <!-- Web Files -->
        <?include WebFeatures.wxi ?>
      </Feature>

      <!-- openXDA Console -->
      <Feature Id="ConsoleFeature" Title="openXDA Remote Console" AllowAdvertise="no" Description="Installs the openXDA remote console used to monitor and interact with the openXDA service.">
        <ComponentGroupRef Id="ConsoleComponents" />
      </Feature>
    </Feature>

    <UI>
      <!-- User Interface -->
      <UIRef Id="WixUI_FeatureTree" />
      <UIRef Id="WixUI_ErrorProgressText" />
      <DialogRef Id="DatabaseConnectionDialog" />
      
      <Publish Dialog="CustomizeDlg" Control="Next" Property="FILEPATH" Value="[#openXDA.exe.config]" Order="1">1</Publish>
      <Publish Dialog="CustomizeDlg" Control="Next" Property="MODE" Value="READ" Order="1">1</Publish>
      <Publish Dialog="CustomizeDlg" Control="Next" Property="PROPERTYMAPPINGS" Value="[CONNECTIONSTRINGMAPPING];;[COMPANYNAMEMAPPING];;[COMPANYACRONYMMAPPING]" Order="1">1</Publish>
      <Publish Dialog="CustomizeDlg" Control="Next" Event="DoAction" Value="ReadConfigFileAction" Order="2">1</Publish>
      <Publish Dialog="CustomizeDlg" Control="Next" Property="XDACONNECTIONSTRING" Value="[DEFAULTCONNECTIONSTRING]" Order="3">NOT XDACONNECTIONSTRING</Publish>
      <Publish Dialog="CustomizeDlg" Control="Next" Property="COMPANYNAME" Value="[DEFAULTCOMPANYNAME]" Order="3">NOT COMPANYNAME</Publish>
      <Publish Dialog="CustomizeDlg" Control="Next" Property="COMPANYACRONYM" Value="[DEFAULTCOMPANYACRONYM]" Order="3">NOT COMPANYACRONYM</Publish>
      <Publish Dialog="CustomizeDlg" Control="Next" Property="CONNECTIONSTRING" Value="[XDACONNECTIONSTRING]" Order="4">1</Publish>
      <Publish Dialog="CustomizeDlg" Control="Next" Property="PROPERTYMAPPINGS" Value="[DBCONNECTIONSTRINGMAPPINGS]" Order="4">1</Publish>
      <Publish Dialog="CustomizeDlg" Control="Next" Event="DoAction" Value="ReadConnectionStringAction" Order="5">1</Publish>
      <Publish Dialog="CustomizeDlg" Control="Next" Property="WINDOWSAUTH" Value="1" Order="6">INTEGRATEDSECURITY = "SSPI"</Publish>
      <Publish Dialog="CustomizeDlg" Control="Next" Property="WINDOWSAUTH" Order="6">NOT(INTEGRATEDSECURITY = "SSPI")</Publish>
      
      <Publish Dialog="CustomizeDlg" Control="Next" Event="NewDialog" Value="ServiceAccountDialog"><![CDATA[&ServiceFeature=3 OR (!ServiceFeature=3 AND &ServiceFeature=-1)]]></Publish>
      <Publish Dialog="CustomizeDlg" Control="Next" Event="NewDialog" Value="DatabaseConnectionDialog"><![CDATA[NOT(&ServiceFeature=3 OR (!ServiceFeature=3 AND &ServiceFeature=-1)) AND (&DatabaseFeature=3 OR (!DatabaseFeature=3 AND &DatabaseFeature=-1))]]></Publish>
      <Publish Dialog="CustomizeDlg" Control="Next" Event="NewDialog" Value="VerifyReadyDlg"><![CDATA[NOT(&ServiceFeature=3 OR (!ServiceFeature=3 AND &ServiceFeature=-1)) AND NOT(&DatabaseFeature=3 OR (!DatabaseFeature=3 AND &DatabaseFeature=-1))]]></Publish>
      <Publish Dialog="VerifyReadyDlg" Control="Back" Event="NewDialog" Value="DatabaseConnectionDialog"><![CDATA[(&ServiceFeature=3 OR (!ServiceFeature=3 AND &ServiceFeature=-1)) OR (&DatabaseFeature=3 OR (!DatabaseFeature=3 AND &DatabaseFeature=-1))]]></Publish>
      <Publish Dialog="VerifyReadyDlg" Control="Back" Event="NewDialog" Value="CustomizeDlg"><![CDATA[NOT((&ServiceFeature=3 OR (!ServiceFeature=3 AND &ServiceFeature=-1)) OR (&DatabaseFeature=3 OR (!DatabaseFeature=3 AND &DatabaseFeature=-1)))]]></Publish>
    </UI>
    
    <Icon Id="openXDA.ico.exe" SourceFile="$(var.openXDA.TargetPath)" />
    <Icon Id="openXDAConsole.ico.exe" SourceFile="$(var.openXDAConsole.TargetPath)" />

    <Property Id="SERVICEACCOUNT" Secure="yes" />
    <Property Id="SERVICENAME" Value="$(var.openXDA.TargetName)" />
    <Property Id="SERVICEPASSWORD" Hidden="yes" />
    <Property Id="HTTPSERVICEPORTS" Value="8989" />
    <Property Id="SERVERNAME" Value="localhost" />
    <Property Id="WINDOWSAUTH" Value="1" />
    
    <Property Id="DEFAULTCOMPANYNAME" Value="Grid Protection Alliance" />
    <Property Id="DEFAULTCOMPANYACRONYM" Value="GPA" />
    <Property Id="COMPANYNAME" Secure="yes" />
    <Property Id="COMPANYACRONYM" Secure="yes" />

    <Property Id="DEFAULTCONNECTIONSTRING" Value="Data Source=localhost;Initial Catalog=openXDA;Integrated Security=SSPI" />
    <Property Id="DATAPROVIDERSTRING" Value="AssemblyName={System.Data, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089};; ConnectionType=System.Data.SqlClient.SqlConnection;; AdapterType=System.Data.SqlClient.SqlDataAdapter" />
    <Property Id="DBCONNECTIONSTRING" Secure="yes" />
    <Property Id="SERVERCONNECTIONSTRING" Secure="yes" />
    <Property Id="XDACONNECTIONSTRING" Secure="yes" />
    
    <Property Id="CREATEDBQUERY" Secure="yes" />
    <Property Id="ALTERDBQUERY" Secure="yes" />
    <Property Id="CREATEDBLOGINQUERY" Secure="yes" />
    <Property Id="ALTERDBLOGINQUERY" Secure="yes" />
    <Property Id="CREATEDBUSERQUERY" Secure="yes" />
    <Property Id="DBPERMISSIONSQUERY" Secure="yes" />
    
    <Property Id="DBCONNECTIONSTRINGMAPPINGS" Value="SERVERNAME=Data Source;DATABASENAME=Initial Catalog;INTEGRATEDSECURITY=Integrated Security;DBUSERNAME=User Id;DBPASSWORD=Password" />
    <Property Id="CONNECTIONSTRINGMAPPING" Value="XDACONNECTIONSTRING={//add[@name='ConnectionString']/@value}" />
    <Property Id="COMPANYNAMEMAPPING" Value="COMPANYNAME={//add[@name='CompanyName']/@value}" />
    <Property Id="COMPANYACRONYMMAPPING" Value="COMPANYACRONYM={//add[@name='CompanyAcronym']/@value}" />
    
    <SetProperty Id="SERVICEACCOUNT" Value="NT SERVICE\[SERVICENAME]" After="LaunchConditions" Sequence="first" />
    <SetProperty Id="DATABASENAME" Value="[SERVICENAME]" After="LaunchConditions" Sequence="first" />
    
    <WixVariable Id="WixUIBannerBmp" Value="$(var.ProjectDir)\openXDASetupBanner.bmp" />
    <WixVariable Id="WixUIDialogBmp" Value="$(var.ProjectDir)\openXDASetupDialog.bmp" />
    <WixVariable Id="WixUILicenseRtf" Value="$(var.ProjectDir)\INSTALL_LICENSE.rtf" />
    
    <!-- Add/Remove Programs Properties -->
    <Property Id="ARPPRODUCTICON" Value="openXDA.ico.exe" />
    
    <!-- Custom Actions -->
    <Binary Id="InstallerActions" SourceFile="$(var.SolutionDir)\Dependencies\GSF\GSF.InstallerActions.CA.dll" />

    <CustomAction Id="ReadConfigFileAction" BinaryKey="InstallerActions" DllEntry="XmlFileAction" Execute="immediate" />
    <CustomAction Id="ReadConnectionStringAction" BinaryKey="InstallerActions" DllEntry="ConnectionStringAction" Execute="immediate" />
    <CustomAction Id="AuthenticateServiceAccountAction" BinaryKey="InstallerActions" DllEntry="AuthenticateServiceAccountAction" Execute="immediate" />
    <CustomAction Id="PasswordGenerationAction" BinaryKey="InstallerActions" DllEntry="PasswordGenerationAction" Execute="immediate" />
    <CustomAction Id="TestDatabaseConnectionAction" BinaryKey="InstallerActions" DllEntry="TestDatabaseConnectionAction" Execute="immediate" />

    <CustomAction Id="UpdateConfigFileAction.SetProperty" Property="UpdateConfigFileAction" Value="FilePath=[#openXDA.exe.config];Mode=WRITE;PropertyMappings=[CONNECTIONSTRINGMAPPING];;[COMPANYNAMEMAPPING];;[COMPANYACRONYMMAPPING];XDACONNECTIONSTRING=[XDACONNECTIONSTRING];COMPANYNAME=[COMPANYNAME];COMPANYACRONYM=[COMPANYACRONYM]" />
    <CustomAction Id="UpdateConfigFileAction" BinaryKey="InstallerActions" DllEntry="XmlFileAction" Execute="deferred" Impersonate="no" />
    <CustomAction Id="ConfigureServiceAction.SetProperty" Property="ConfigureServiceAction" Value="SERVICENAME=[SERVICENAME]" />
    <CustomAction Id="ConfigureServiceAction" BinaryKey="InstallerActions" DllEntry="ConfigureServiceAction" Execute="deferred" Impersonate="no" />
    <CustomAction Id="ServiceAccountAction.SetProperty" Property="ServiceAccountAction" Value="SERVICENAME=[SERVICENAME];SERVICEACCOUNT=[SERVICEACCOUNT];HTTPSERVICEPORTS=[HTTPSERVICEPORTS]" />
    <CustomAction Id="ServiceAccountAction" BinaryKey="InstallerActions" DllEntry="ServiceAccountAction" Execute="deferred" Impersonate="no" />
    
    <CustomAction Id="CreateDatabase.SetProperty" Property="CreateDatabase" Value="SERVICENAME=[SERVICENAME];CONNECTIONSTRING=[SERVERCONNECTIONSTRING];DATAPROVIDERSTRING=[DATAPROVIDERSTRING];DBQUERY=[CREATEDBQUERY]" />
    <CustomAction Id="CreateDatabase" BinaryKey="InstallerActions" DllEntry="DatabaseQueryAction" Execute="deferred" Impersonate="yes" />
    <CustomAction Id="AlterDatabase.SetProperty" Property="AlterDatabase" Value="SERVICENAME=[SERVICENAME];CONNECTIONSTRING=[SERVERCONNECTIONSTRING];DATAPROVIDERSTRING=[DATAPROVIDERSTRING];DBQUERY=[ALTERDBQUERY]" />
    <CustomAction Id="AlterDatabase" BinaryKey="InstallerActions" DllEntry="DatabaseQueryAction" Execute="deferred" Impersonate="yes" />
    <CustomAction Id="CreateDBLogin.SetProperty" Property="CreateDBLogin" Value="SERVICENAME=[SERVICENAME];CONNECTIONSTRING=[SERVERCONNECTIONSTRING];DATAPROVIDERSTRING=[DATAPROVIDERSTRING];DBQUERY=[CREATEDBLOGINQUERY]" />
    <CustomAction Id="CreateDBLogin" BinaryKey="InstallerActions" DllEntry="DatabaseQueryAction" Execute="deferred" Impersonate="yes" />
    <CustomAction Id="AlterDBLogin.SetProperty" Property="AlterDBLogin" Value="SERVICENAME=[SERVICENAME];CONNECTIONSTRING=[SERVERCONNECTIONSTRING];DATAPROVIDERSTRING=[DATAPROVIDERSTRING];DBQUERY=[ALTERDBLOGINQUERY]" />
    <CustomAction Id="AlterDBLogin" BinaryKey="InstallerActions" DllEntry="DatabaseQueryAction" Execute="deferred" Impersonate="yes" />
    <CustomAction Id="CreateDBUser.SetProperty" Property="CreateDBUser" Value="SERVICENAME=[SERVICENAME];CONNECTIONSTRING=[DBCONNECTIONSTRING];DATAPROVIDERSTRING=[DATAPROVIDERSTRING];DBQUERY=[CREATEDBUSERQUERY]" />
    <CustomAction Id="CreateDBUser" BinaryKey="InstallerActions" DllEntry="DatabaseQueryAction" Execute="deferred" Impersonate="yes" />
    <CustomAction Id="GrantDBPermissions.SetProperty" Property="GrantDBPermissions" Value="SERVICENAME=[SERVICENAME];CONNECTIONSTRING=[DBCONNECTIONSTRING];DATAPROVIDERSTRING=[DATAPROVIDERSTRING];DBQUERY=[DBPERMISSIONSQUERY]" />
    <CustomAction Id="GrantDBPermissions" BinaryKey="InstallerActions" DllEntry="DatabaseQueryAction" Execute="deferred" Impersonate="yes" />

    <?include obj\SqlClr.wxi ?>
    <CustomAction Id="GSF.SortedTreeStore.SqlClr.SetProperty" Property="GSF.SortedTreeStore.SqlClr" Value="SERVICENAME=[SERVICENAME];CONNECTIONSTRING=[DBCONNECTIONSTRING];DATAPROVIDERSTRING=[DATAPROVIDERSTRING];DBQUERY=CREATE ASSEMBLY [\[]GSF.SortedTreeStore.SqlClr[\]] AUTHORIZATION dbo FROM [GSF.SortedTreeStore.SqlClr.dll] WITH PERMISSION_SET = UNSAFE" />
    <CustomAction Id="GSF.SortedTreeStore.SqlClr" BinaryKey="InstallerActions" DllEntry="DatabaseQueryAction" Execute="deferred" Impersonate="yes" />
    <CustomAction Id="openHistorian.Core.SqlClr.SetProperty" Property="openHistorian.Core.SqlClr" Value="SERVICENAME=[SERVICENAME];CONNECTIONSTRING=[DBCONNECTIONSTRING];DATAPROVIDERSTRING=[DATAPROVIDERSTRING];DBQUERY=CREATE ASSEMBLY [\[]openHistorian.Core.SqlClr[\]] AUTHORIZATION dbo FROM [openHistorian.Core.SqlClr.dll] WITH PERMISSION_SET = UNSAFE" />
    <CustomAction Id="openHistorian.Core.SqlClr" BinaryKey="InstallerActions" DllEntry="DatabaseQueryAction" Execute="deferred" Impersonate="yes" />
    <CustomAction Id="openHistorian.SqlClr.SetProperty" Property="openHistorian.SqlClr" Value="SERVICENAME=[SERVICENAME];CONNECTIONSTRING=[DBCONNECTIONSTRING];DATAPROVIDERSTRING=[DATAPROVIDERSTRING];DBQUERY=CREATE ASSEMBLY [\[]openHistorian.SqlClr[\]] AUTHORIZATION dbo FROM [openHistorian.SqlClr.dll] WITH PERMISSION_SET = UNSAFE" />
    <CustomAction Id="openHistorian.SqlClr" BinaryKey="InstallerActions" DllEntry="DatabaseQueryAction" Execute="deferred" Impersonate="yes" />
    <CustomAction Id="openHistorian.XDALink.SqlClr.SetProperty" Property="openHistorian.XDALink.SqlClr" Value="SERVICENAME=[SERVICENAME];CONNECTIONSTRING=[DBCONNECTIONSTRING];DATAPROVIDERSTRING=[DATAPROVIDERSTRING];DBQUERY=CREATE ASSEMBLY [\[]openHistorian.XDALink.SqlClr[\]] AUTHORIZATION dbo FROM [openHistorian.XDALink.SqlClr.dll] WITH PERMISSION_SET = UNSAFE" />
    <CustomAction Id="openHistorian.XDALink.SqlClr" BinaryKey="InstallerActions" DllEntry="DatabaseQueryAction" Execute="deferred" Impersonate="yes" />
    <CustomAction Id="openXDA.SqlClr.SetProperty" Property="openXDA.SqlClr" Value="SERVICENAME=[SERVICENAME];CONNECTIONSTRING=[DBCONNECTIONSTRING];DATAPROVIDERSTRING=[DATAPROVIDERSTRING];DBQUERY=CREATE ASSEMBLY [\[]openXDA.SqlClr[\]] AUTHORIZATION dbo FROM [openXDA.SqlClr.dll]" />
    <CustomAction Id="openXDA.SqlClr" BinaryKey="InstallerActions" DllEntry="DatabaseQueryAction" Execute="deferred" Impersonate="yes" />
    
    <CustomAction Id="openXDA.sql.SetProperty" Property="openXDA.sql" Value="SERVICENAME=[SERVICENAME];CONNECTIONSTRING=[DBCONNECTIONSTRING];DATAPROVIDERSTRING=[DATAPROVIDERSTRING];SCRIPTPATH=[#openXDA.sql]" />
    <CustomAction Id="openXDA.sql" BinaryKey="InstallerActions" DllEntry="DatabaseScriptAction" Execute="deferred" Impersonate="yes" />
    <CustomAction Id="DashSprocs.sql.SetProperty" Property="DashSprocs.sql" Value="SERVICENAME=[SERVICENAME];CONNECTIONSTRING=[DBCONNECTIONSTRING];DATAPROVIDERSTRING=[DATAPROVIDERSTRING];SCRIPTPATH=[#DashSprocs.sql]" />
    <CustomAction Id="DashSprocs.sql" BinaryKey="InstallerActions" DllEntry="DatabaseScriptAction" Execute="deferred" Impersonate="yes" />
    <CustomAction Id="EnableHistorianSqlClr.sql.SetProperty" Property="EnableHistorianSqlClr.sql" Value="SERVICENAME=[SERVICENAME];CONNECTIONSTRING=[DBCONNECTIONSTRING];DATAPROVIDERSTRING=[DATAPROVIDERSTRING];SCRIPTPATH=[#EnableHistorianSqlClr.sql]" />
    <CustomAction Id="EnableHistorianSqlClr.sql" BinaryKey="InstallerActions" DllEntry="DatabaseScriptAction" Execute="deferred" Impersonate="yes" />
    <CustomAction Id="DefaultSettings.sql.SetProperty" Property="DefaultSettings.sql" Value="SERVICENAME=[SERVICENAME];CONNECTIONSTRING=[DBCONNECTIONSTRING];DATAPROVIDERSTRING=[DATAPROVIDERSTRING];SCRIPTPATH=[#DefaultSettings.sql]" />
    <CustomAction Id="DefaultSettings.sql" BinaryKey="InstallerActions" DllEntry="DatabaseScriptAction" Execute="deferred" Impersonate="yes" />
    <CustomAction Id="DefaultChannelTypes.sql.SetProperty" Property="DefaultChannelTypes.sql" Value="SERVICENAME=[SERVICENAME];CONNECTIONSTRING=[DBCONNECTIONSTRING];DATAPROVIDERSTRING=[DATAPROVIDERSTRING];SCRIPTPATH=[#DefaultChannelTypes.sql]" />
    <CustomAction Id="DefaultChannelTypes.sql" BinaryKey="InstallerActions" DllEntry="DatabaseScriptAction" Execute="deferred" Impersonate="yes" />
    <CustomAction Id="DefaultTrendingAlarms.sql.SetProperty" Property="DefaultTrendingAlarms.sql" Value="SERVICENAME=[SERVICENAME];CONNECTIONSTRING=[DBCONNECTIONSTRING];DATAPROVIDERSTRING=[DATAPROVIDERSTRING];SCRIPTPATH=[#DefaultTrendingAlarms.sql]" />
    <CustomAction Id="DefaultTrendingAlarms.sql" BinaryKey="InstallerActions" DllEntry="DatabaseScriptAction" Execute="deferred" Impersonate="yes" />
    <CustomAction Id="DefaultContours.sql.SetProperty" Property="DefaultContours.sql" Value="SERVICENAME=[SERVICENAME];CONNECTIONSTRING=[DBCONNECTIONSTRING];DATAPROVIDERSTRING=[DATAPROVIDERSTRING];SCRIPTPATH=[#DefaultContours.sql]" />
    <CustomAction Id="DefaultContours.sql" BinaryKey="InstallerActions" DllEntry="DatabaseScriptAction" Execute="deferred" Impersonate="yes" />
    
    <InstallExecuteSequence>
      <Custom Action="UpdateConfigFileAction.SetProperty" After="InstallFiles"><![CDATA[NOT REMOVE AND (&ServiceFeature=3 OR (!ServiceFeature=3 AND &ServiceFeature=-1))]]></Custom>
      <Custom Action="UpdateConfigFileAction" After="UpdateConfigFileAction.SetProperty"><![CDATA[NOT REMOVE AND (&ServiceFeature=3 OR (!ServiceFeature=3 AND &ServiceFeature=-1))]]></Custom>
      <Custom Action="ConfigureServiceAction.SetProperty" After="InstallServices"><![CDATA[NOT REMOVE AND &ServiceFeature=3]]></Custom>
      <Custom Action="ConfigureServiceAction" After="ConfigureServiceAction.SetProperty"><![CDATA[NOT REMOVE AND &ServiceFeature=3]]></Custom>
      <Custom Action="ServiceAccountAction.SetProperty" After="ConfigureServiceAction"><![CDATA[NOT REMOVE AND (&ServiceFeature=3 OR (!ServiceFeature=3 AND &ServiceFeature=-1))]]></Custom>
      <Custom Action="ServiceAccountAction" After="ServiceAccountAction.SetProperty"><![CDATA[NOT REMOVE AND (&ServiceFeature=3 OR (!ServiceFeature=3 AND &ServiceFeature=-1))]]></Custom>
      
      <Custom Action="CreateDatabase.SetProperty" After="InstallFiles"><![CDATA[NOT REMOVE AND (&DatabaseFeature=3 OR (!DatabaseFeature=3 AND &DatabaseFeature=-1))]]></Custom>
      <Custom Action="CreateDatabase" After="CreateDatabase.SetProperty"><![CDATA[NOT REMOVE AND (&DatabaseFeature=3 OR (!DatabaseFeature=3 AND &DatabaseFeature=-1))]]></Custom>
      <Custom Action="AlterDatabase.SetProperty" After="CreateDatabase"><![CDATA[NOT REMOVE AND (&DatabaseFeature=3 OR (!DatabaseFeature=3 AND &DatabaseFeature=-1))]]></Custom>
      <Custom Action="AlterDatabase" After="AlterDatabase.SetProperty"><![CDATA[NOT REMOVE AND (&DatabaseFeature=3 OR (!DatabaseFeature=3 AND &DatabaseFeature=-1))]]></Custom>
      <Custom Action="CreateDBLogin.SetProperty" After="AlterDatabase"><![CDATA[NOT REMOVE AND (&DatabaseFeature=3 OR (!DatabaseFeature=3 AND &DatabaseFeature=-1))]]></Custom>
      <Custom Action="CreateDBLogin" After="CreateDBLogin.SetProperty"><![CDATA[NOT REMOVE AND (&DatabaseFeature=3 OR (!DatabaseFeature=3 AND &DatabaseFeature=-1))]]></Custom>
      <Custom Action="AlterDBLogin.SetProperty" After="CreateDBLogin"><![CDATA[NOT REMOVE AND (&DatabaseFeature=3 OR (!DatabaseFeature=3 AND &DatabaseFeature=-1))]]></Custom>
      <Custom Action="AlterDBLogin" After="AlterDBLogin.SetProperty"><![CDATA[NOT REMOVE AND (&DatabaseFeature=3 OR (!DatabaseFeature=3 AND &DatabaseFeature=-1))]]></Custom>
      <Custom Action="CreateDBUser.SetProperty" After="AlterDBLogin"><![CDATA[NOT REMOVE AND (&DatabaseFeature=3 OR (!DatabaseFeature=3 AND &DatabaseFeature=-1))]]></Custom>
      <Custom Action="CreateDBUser" After="CreateDBUser.SetProperty"><![CDATA[NOT REMOVE AND (&DatabaseFeature=3 OR (!DatabaseFeature=3 AND &DatabaseFeature=-1))]]></Custom>
      <Custom Action="GrantDBPermissions.SetProperty" After="CreateDBUser"><![CDATA[NOT REMOVE AND (&DatabaseFeature=3 OR (!DatabaseFeature=3 AND &DatabaseFeature=-1))]]></Custom>
      <Custom Action="GrantDBPermissions" After="GrantDBPermissions.SetProperty"><![CDATA[NOT REMOVE AND (&DatabaseFeature=3 OR (!DatabaseFeature=3 AND &DatabaseFeature=-1))]]></Custom>

      <Custom Action="GSF.SortedTreeStore.SqlClr.SetProperty" After="GrantDBPermissions"><![CDATA[NOT REMOVE AND (&DatabaseFeature=3 OR (!DatabaseFeature=3 AND &DatabaseFeature=-1))]]></Custom>
      <Custom Action="GSF.SortedTreeStore.SqlClr" After="GSF.SortedTreeStore.SqlClr.SetProperty"><![CDATA[NOT REMOVE AND (&DatabaseFeature=3 OR (!DatabaseFeature=3 AND &DatabaseFeature=-1))]]></Custom>
      <Custom Action="openHistorian.Core.SqlClr.SetProperty" After="GSF.SortedTreeStore.SqlClr"><![CDATA[NOT REMOVE AND (&DatabaseFeature=3 OR (!DatabaseFeature=3 AND &DatabaseFeature=-1))]]></Custom>
      <Custom Action="openHistorian.Core.SqlClr" After="openHistorian.Core.SqlClr.SetProperty"><![CDATA[NOT REMOVE AND (&DatabaseFeature=3 OR (!DatabaseFeature=3 AND &DatabaseFeature=-1))]]></Custom>
      <Custom Action="openHistorian.SqlClr.SetProperty" After="openHistorian.Core.SqlClr"><![CDATA[NOT REMOVE AND (&DatabaseFeature=3 OR (!DatabaseFeature=3 AND &DatabaseFeature=-1))]]></Custom>
      <Custom Action="openHistorian.SqlClr" After="openHistorian.SqlClr.SetProperty"><![CDATA[NOT REMOVE AND (&DatabaseFeature=3 OR (!DatabaseFeature=3 AND &DatabaseFeature=-1))]]></Custom>
      <Custom Action="openHistorian.XDALink.SqlClr.SetProperty" After="openHistorian.SqlClr"><![CDATA[NOT REMOVE AND (&DatabaseFeature=3 OR (!DatabaseFeature=3 AND &DatabaseFeature=-1))]]></Custom>
      <Custom Action="openHistorian.XDALink.SqlClr" After="openHistorian.XDALink.SqlClr.SetProperty"><![CDATA[NOT REMOVE AND (&DatabaseFeature=3 OR (!DatabaseFeature=3 AND &DatabaseFeature=-1))]]></Custom>
      <Custom Action="openXDA.SqlClr.SetProperty" After="openHistorian.XDALink.SqlClr"><![CDATA[NOT REMOVE AND (&DatabaseFeature=3 OR (!DatabaseFeature=3 AND &DatabaseFeature=-1))]]></Custom>
      <Custom Action="openXDA.SqlClr" After="openXDA.SqlClr.SetProperty"><![CDATA[NOT REMOVE AND (&DatabaseFeature=3 OR (!DatabaseFeature=3 AND &DatabaseFeature=-1))]]></Custom>
      
      <Custom Action="openXDA.sql.SetProperty" After="openXDA.SqlClr"><![CDATA[NOT REMOVE AND (&DatabaseFeature=3 OR (!DatabaseFeature=3 AND &DatabaseFeature=-1))]]></Custom>
      <Custom Action="openXDA.sql" After="openXDA.sql.SetProperty"><![CDATA[NOT REMOVE AND (&DatabaseFeature=3 OR (!DatabaseFeature=3 AND &DatabaseFeature=-1))]]></Custom>
      <Custom Action="DashSprocs.sql.SetProperty" After="openXDA.sql"><![CDATA[NOT REMOVE AND (&DatabaseFeature=3 OR (!DatabaseFeature=3 AND &DatabaseFeature=-1))]]></Custom>
      <Custom Action="DashSprocs.sql" After="DashSprocs.sql.SetProperty"><![CDATA[NOT REMOVE AND (&DatabaseFeature=3 OR (!DatabaseFeature=3 AND &DatabaseFeature=-1))]]></Custom>
      <Custom Action="EnableHistorianSqlClr.sql.SetProperty" After="DashSprocs.sql"><![CDATA[NOT REMOVE AND (&DatabaseFeature=3 OR (!DatabaseFeature=3 AND &DatabaseFeature=-1))]]></Custom>
      <Custom Action="EnableHistorianSqlClr.sql" After="EnableHistorianSqlClr.sql.SetProperty"><![CDATA[NOT REMOVE AND (&DatabaseFeature=3 OR (!DatabaseFeature=3 AND &DatabaseFeature=-1))]]></Custom>
      <Custom Action="DefaultSettings.sql.SetProperty" After="EnableHistorianSqlClr.sql"><![CDATA[NOT REMOVE AND (&DatabaseFeature=3 OR (!DatabaseFeature=3 AND &DatabaseFeature=-1))]]></Custom>
      <Custom Action="DefaultSettings.sql" After="DefaultSettings.sql.SetProperty"><![CDATA[NOT REMOVE AND (&DatabaseFeature=3 OR (!DatabaseFeature=3 AND &DatabaseFeature=-1))]]></Custom>
      <Custom Action="DefaultChannelTypes.sql.SetProperty" After="DefaultSettings.sql"><![CDATA[NOT REMOVE AND (&DatabaseFeature=3 OR (!DatabaseFeature=3 AND &DatabaseFeature=-1))]]></Custom>
      <Custom Action="DefaultChannelTypes.sql" After="DefaultChannelTypes.sql.SetProperty"><![CDATA[NOT REMOVE AND (&DatabaseFeature=3 OR (!DatabaseFeature=3 AND &DatabaseFeature=-1))]]></Custom>
      <Custom Action="DefaultTrendingAlarms.sql.SetProperty" After="DefaultChannelTypes.sql"><![CDATA[NOT REMOVE AND (&DatabaseFeature=3 OR (!DatabaseFeature=3 AND &DatabaseFeature=-1))]]></Custom>
      <Custom Action="DefaultTrendingAlarms.sql" After="DefaultTrendingAlarms.sql.SetProperty"><![CDATA[NOT REMOVE AND (&DatabaseFeature=3 OR (!DatabaseFeature=3 AND &DatabaseFeature=-1))]]></Custom>
      <Custom Action="DefaultContours.sql.SetProperty" After="DefaultTrendingAlarms.sql"><![CDATA[NOT REMOVE AND (&DatabaseFeature=3 OR (!DatabaseFeature=3 AND &DatabaseFeature=-1))]]></Custom>
      <Custom Action="DefaultContours.sql" After="DefaultContours.sql.SetProperty"><![CDATA[NOT REMOVE AND (&DatabaseFeature=3 OR (!DatabaseFeature=3 AND &DatabaseFeature=-1))]]></Custom>
    </InstallExecuteSequence>
  </Product>

  <Fragment>
    <Directory Id="TARGETDIR" Name="SourceDir">
      <?if $(var.Platform) = x64 ?>
        <Directory Id="ProgramFiles64Folder">
          <!-- C:\Program Files\openXDA -->
          <Directory Id="INSTALLFOLDER" Name="openXDA">
            <Component Id="InstallFolderPermissions" Guid="{414759B2-2C29-4C37-978E-D1C8DC4DF4E1}">
              <CreateFolder>
                <util:PermissionEx User="[SERVICENAME] Admins" CreateFile="yes" CreateChild="yes" GenericRead="yes" GenericWrite="yes" GenericExecute="yes" Delete="yes" DeleteChild="yes" />
              </CreateFolder>
            </Component>
            
            <Directory Id="DEBUGFOLDER" Name="Debug" />
            <Directory Id="RESULTSFOLDER" Name="Results" />
            <Directory Id="WATCHFOLDER" Name="Watch" />
            <?include WebFolders.wxi ?>
          </Directory>
        </Directory>
      <?else ?>
        <Directory Id="ProgramFilesFolder">
          <!-- C:\Program Files (x86)\openXDA -->
          <Directory Id="INSTALLFOLDER" Name="openXDA">
            <Component Id="InstallFolderPermissions" Guid="{414759B2-2C29-4C37-978E-D1C8DC4DF4E1}">
              <CreateFolder>
                <util:PermissionEx User="[SERVICENAME] Admins" CreateFile="yes" CreateChild="yes" GenericRead="yes" GenericWrite="yes" GenericExecute="yes" Delete="yes" DeleteChild="yes" />
              </CreateFolder>
            </Component>
            
            <Directory Id="DEBUGFOLDER" Name="Debug" />
            <Directory Id="RESULTSFOLDER" Name="Results" />
            <Directory Id="WATCHFOLDER" Name="Watch" />
            <?include WebFolders.wxi ?>
          </Directory>
        </Directory>
      <?endif ?>

      <Directory Id="ProgramMenuFolder">
        <Directory Id="ApplicationProgramsFolder" Name="openXDA" />
      </Directory>
    </Directory>
  </Fragment>

  <Fragment>
    <?include WebFiles.wxi ?>
  </Fragment>

  <Fragment>
    <!-- Database Components -->
    <ComponentGroup Id="DatabaseComponents" Directory="INSTALLFOLDER">
      <!-- Database Scripts -->
      <Component Id="DBScript">
        <File Id="openXDA.sql" Name="openXDA.sql" Source="$(var.SolutionDir)\Data\01 - openXDA.sql" />
      </Component>
      <Component Id="DashScript">
        <File Id="DashSprocs.sql" Name="DashSprocs.sql" Source="$(var.SolutionDir)\Data\02 - DashSprocs.sql" />
      </Component>
      <Component Id="EnableHistorianSqlClr">
        <File Id="EnableHistorianSqlClr.sql" Name="EnableHistorianSqlClr.sql" Source="$(var.SolutionDir)\Data\03 - EnableHistorianSqlClr.sql" />
      </Component>
      <Component Id="DefaultSettings">
        <File Id="DefaultSettings.sql" Name="DefaultSettings.sql" Source="$(var.SolutionDir)\Data\04 - DefaultSettings.sql" />
      </Component>
      <Component Id="DefaultChannelTypes">
        <File Id="DefaultChannelTypes.sql" Name="DefaultChannelTypes.sql" Source="$(var.SolutionDir)\Data\05 - DefaultChannelTypes.sql" />
      </Component>
      <Component Id="DefaultTrendingAlarms">
        <File Id="DefaultTrendingAlarms.sql" Name="DefaultTrendingAlarms.sql" Source="$(var.SolutionDir)\Data\06 - DefaultTrendingAlarms.sql" />
      </Component>
      <Component Id="DefaultContours">
        <File Id="DefaultContours.sql" Name="DefaultContours.sql" Source="$(var.SolutionDir)\Data\07 - DefaultContours.sql" />
      </Component>
    </ComponentGroup>
    
    <!-- Service Components -->
    <ComponentGroup Id="ServiceComponents" Directory="INSTALLFOLDER">
      <!-- Service Applications -->
      <Component Id="openXDA">
        <File Id="openXDA.exe" Name="$(var.openXDA.TargetFileName)" Source="$(var.openXDA.TargetPath)" />
        <ServiceInstall Id="openXDAService" Name="openXDA" Account="[SERVICEACCOUNT]" Password="[SERVICEPASSWORD]" Type="ownProcess" Start="auto" ErrorControl="normal" Description="Engine for detecting and locating faults by analyzing power quality data files." />
        <ServiceControl Id="openXDAServiceControl" Name="openXDA" Start="install" Stop="both" Remove="uninstall" />
      </Component>
      <Component Id="openXDAConfig" Permanent="yes">
        <File Id="openXDA.exe.config" Name="$(var.openXDA.TargetFileName).config" Source="$(var.openXDA.ProjectDir)\app.config" />
      </Component>
      <Component Id="DeviceDefinitionsMigrator">
        <File Id="DeviceDefinitionsMigrator.exe" Name="$(var.DeviceDefinitionsMigrator.TargetFileName)" Source="$(var.DeviceDefinitionsMigrator.TargetPath)" />
      </Component>
      <Component Id="ldconfig.bat">
        <File Id="ldconfig.bat" Name="ldconfig.bat" Source="$(var.DeviceDefinitionsMigrator.ProjectDir)\ldconfig.bat" />
      </Component>
      <Component Id="ldconfig.ps1">
        <File Id="ldconfig.ps1" Name="ldconfig.ps1" Source="$(var.DeviceDefinitionsMigrator.ProjectDir)\ldconfig.ps1" />
      </Component>
      
      <!-- Database Scripts -->
      <ComponentRef Id="DBScript" />
      
      <!-- XDA Libraries -->
      <ComponentRef Id="FaultAlgorithms" />
      <ComponentRef Id="FaultData" />
      <ComponentRef Id="JSONApi" />
      <ComponentRef Id="openHistorian.XDALink" />

      <!-- DotNetZip Dependencies -->
      <ComponentRef Id="Ionic.Zlib" />

      <!-- log4net Dependencies -->
      <ComponentRef Id="log4net" />

      <!-- GSF Dependencies -->
      <ComponentRef Id="Antlr3.Runtime" />
      <ComponentRef Id="ExpressionEvaluator" />
      <ComponentRef Id="GSF.COMTRADE" />
      <ComponentRef Id="GSF.Communication" />
      <ComponentRef Id="GSF.Core" />
      <ComponentRef Id="GSF.EMAX" />
      <ComponentRef Id="GSF.PhasorProtocols" />
      <ComponentRef Id="GSF.PQDIF" />
      <ComponentRef Id="GSF.Security" />
      <ComponentRef Id="GSF.ServiceProcess" />
      <ComponentRef Id="GSF.SELEventParser" />
      <ComponentRef Id="GSF.TimeSeries" />
      <ComponentRef Id="GSF.Web" />
      <ComponentRef Id="TagDefinitions" />

      <!-- openHistorian Dependencies -->
      <ComponentRef Id="crypto" />
      <ComponentRef Id="GSF.SortedTreeStore" />
      <ComponentRef Id="openHistorian.Core" />

      <!-- Self Hosting SignalR, WebAPI and Razor Engine Components (from NuGet) -->
      <ComponentRef Id="Microsoft.AspNet.Razor" />
      <ComponentRef Id="Microsoft.AspNet.SignalR.Core" />
      <ComponentRef Id="System.Net.Http.Formatting" />
      <ComponentRef Id="System.Web.Http" />
      <ComponentRef Id="System.Web.Http.Owin" />
      <ComponentRef Id="Microsoft.CodeDom.Providers.DotNetCompilerPlatform" />
      <ComponentRef Id="Microsoft.Owin" />
      <ComponentRef Id="Microsoft.Owin.Diagnostics" />
      <ComponentRef Id="Microsoft.Owin.Host.HttpListener" />
      <ComponentRef Id="Microsoft.Owin.Hosting" />
      <ComponentRef Id="Microsoft.Owin.Security" />
      <ComponentRef Id="Newtonsoft.Json" />
      <ComponentRef Id="Owin" />
      <ComponentRef Id="RazorEngine" />
      <ComponentRef Id="System.Web.Razor" />
      <ComponentRef Id="AjaxMin" />

      <ComponentRef Id="InstallFolderPermissions"/>
      
      <!-- Cleanup -->
      <Component Id="Cleanup" Guid="{C8EBB158-C708-4C94-87C1-F5DBC77D7BDE}">
        <CreateFolder />
        <RemoveFolder Id="RemoveDebugFolder" Directory="DEBUGFOLDER" On="uninstall" />
        <RemoveFolder Id="RemoveResultsFolder" Directory="RESULTSFOLDER" On="uninstall" />
        <RemoveFolder Id="RemoveWatchFolder" Directory="WATCHFOLDER" On="uninstall" />
        <RemoveFolder Id="RemoveApplicationProgramsFolder" Directory="ApplicationProgramsFolder" On="uninstall" />
        <RemoveFolder Id="RemoveInstallFolder" Directory="INSTALLFOLDER" On="uninstall" />
      </Component>
    </ComponentGroup>

    <!-- Console Components -->
    <ComponentGroup Id="ConsoleComponents" Directory="INSTALLFOLDER">
      <!-- Remote Console Applications -->
      <Component Id="openXDAConsole">
        <File Id="openXDAConsole.exe" Name="$(var.openXDAConsole.TargetFileName)" Source="$(var.openXDAConsole.TargetPath)" />
        <Shortcut Id="openXDAConsoleStartMenuShortcut" Name="openXDA Console" Icon="openXDAConsole.ico.exe" Description="Console application to monitor the openXDA service." WorkingDirectory="INSTALLFOLDER" Directory="ApplicationProgramsFolder" Advertise="yes" />
      </Component>
      <Component Id="openXDAConsoleConfig">
        <File Id="openXDAConsole.exe.config" Name="$(var.openXDAConsole.TargetFileName).config" Source="$(var.openXDAConsole.TargetPath).config" />
      </Component>

      <!-- GSF Dependencies -->
      <ComponentRef Id="GSF.Communication" />
      <ComponentRef Id="GSF.Core" />
      <ComponentRef Id="GSF.Security" />
      <ComponentRef Id="GSF.ServiceProcess" />
    </ComponentGroup>

    <!-- Library Components -->
    <ComponentGroup Id="LibraryComponents" Directory="INSTALLFOLDER">
      <!-- XDA Libraries -->
      <Component Id="FaultAlgorithms">
        <File Id="FaultAlgorithms.dll" Name="$(var.FaultAlgorithms.TargetFileName)" Source="$(var.FaultAlgorithms.TargetPath)" />
      </Component>
      <Component Id="FaultData">
        <File Id="FaultData.dll" Name="$(var.FaultData.TargetFileName)" Source="$(var.FaultData.TargetPath)" />
      </Component>
      <Component Id="JSONApi">
        <File Id="JSONApi.dll" Name="$(var.JSONApi.TargetFileName)" Source="$(var.JSONApi.TargetPath)" />
      </Component>
      <Component Id="openHistorian.XDALink">
        <File Id="openHistorian.XDALink.dll" Name="$(var.openHistorian.XDALink.TargetFileName)" Source="$(var.openHistorian.XDALink.TargetPath)" />
      </Component>
      
      <!-- DotNetZip Dependencies -->
      <Component Id="Ionic.Zlib">
        <File Id="Ionic.Zlib.dll" Name="Ionic.Zlib.dll" Source="$(var.SolutionDir)\Dependencies\DotNetZip\Ionic.Zlib.dll" />
      </Component>
      
      <!-- log4net Dependencies -->
      <Component Id="log4net">
        <File Id="log4net.dll" Name="log4net.dll" Source="$(var.SolutionDir)\Dependencies\NuGet\log4net.2.0.3\lib\net40-full\log4net.dll" />
      </Component>

      
      <!-- GSF Dependencies -->
      <Component Id="Antlr3.Runtime">
        <File Id="Antlr3.Runtime.dll" Name="Antlr3.Runtime.dll" Source="$(var.SolutionDir)\Dependencies\GSF\Antlr3.Runtime.dll" />
      </Component>
      <Component Id="ExpressionEvaluator">
        <File Id="ExpressionEvaluator.dll" Name="ExpressionEvaluator.dll" Source="$(var.SolutionDir)\Dependencies\GSF\ExpressionEvaluator.dll" />
      </Component>
      <Component Id="GSF.COMTRADE">
        <File Id="GSF.COMTRADE.dll" Name="GSF.COMTRADE.dll" Source="$(var.SolutionDir)\Dependencies\GSF\GSF.COMTRADE.dll" />
      </Component>
      <Component Id="GSF.Communication">
        <File Id="GSF.Communication.dll" Name="GSF.Communication.dll" Source="$(var.SolutionDir)\Dependencies\GSF\GSF.Communication.dll" />
      </Component>
      <Component Id="GSF.Core">
        <File Id="GSF.Core.dll" Name="GSF.Core.dll" Source="$(var.SolutionDir)\Dependencies\GSF\GSF.Core.dll" />
      </Component>
      <Component Id="GSF.EMAX">
        <File Id="GSF.EMAX.dll" Name="GSF.EMAX.dll" Source="$(var.SolutionDir)\Dependencies\GSF\GSF.EMAX.dll" />
      </Component>
      <Component Id="GSF.PhasorProtocols">
        <File Id="GSF.PhasorProtocols.dll" Name="GSF.PhasorProtocols.dll" Source="$(var.SolutionDir)\Dependencies\GSF\GSF.PhasorProtocols.dll" />
      </Component>
      <Component Id="GSF.PQDIF">
        <File Id="GSF.PQDIF.dll" Name="GSF.PQDIF.dll" Source="$(var.SolutionDir)\Dependencies\GSF\GSF.PQDIF.dll" />
      </Component>
      <Component Id="GSF.Security">
        <File Id="GSF.Security.dll" Name="GSF.Security.dll" Source="$(var.SolutionDir)\Dependencies\GSF\GSF.Security.dll" />
      </Component>
      <Component Id="GSF.ServiceProcess">
        <File Id="GSF.ServiceProcess.dll" Name="GSF.ServiceProcess.dll" Source="$(var.SolutionDir)\Dependencies\GSF\GSF.ServiceProcess.dll" />
      </Component>
      <Component Id="GSF.SELEventParser">
        <File Id="GSF.SELEventParser.dll" Name="GSF.SELEventParser.dll" Source="$(var.SolutionDir)\Dependencies\GSF\GSF.SELEventParser.dll" />
      </Component>
      <Component Id="GSF.TimeSeries">
        <File Id="GSF.TimeSeries.dll" Name="GSF.TimeSeries.dll" Source="$(var.SolutionDir)\Dependencies\GSF\GSF.TimeSeries.dll" />
      </Component>
      <Component Id="GSF.Web">
        <File Id="GSF.Web.dll" Name="GSF.Web.dll" Source="$(var.SolutionDir)\Dependencies\GSF\GSF.Web.dll" />
      </Component>
      <Component Id="TagDefinitions">
        <File Id="TagDefinitions.xml" Name="TagDefinitions.xml" Source="$(var.SolutionDir)\Dependencies\GSF\TagDefinitions.xml" />
      </Component>

      <!-- openHistorian Dependencies -->
      <Component Id="crypto">
        <File Id="crypto.dll" Name="crypto.dll" Source="$(var.SolutionDir)\Dependencies\openHistorian\crypto.dll" />
      </Component>
      <Component Id="GSF.SortedTreeStore">
        <File Id="GSF.SortedTreeStore.dll" Name="GSF.SortedTreeStore.dll" Source="$(var.SolutionDir)\Dependencies\openHistorian\GSF.SortedTreeStore.dll" />
      </Component>
      <Component Id="openHistorian.Core">
        <File Id="openHistorian.Core.dll" Name="openHistorian.Core.dll" Source="$(var.SolutionDir)\Dependencies\openHistorian\openHistorian.Core.dll" />
      </Component>

      <!-- Self Hosting SignalR, WebAPI and Razor Engine Components (from NuGet) -->
      <Component Id="Microsoft.AspNet.Razor">
        <File Id="Microsoft.AspNet.Razor.dll" Name="Microsoft.AspNet.Razor.dll" Source="$(var.SolutionDir)Dependencies\NuGet\Microsoft.AspNet.Razor.4.0.0-beta7\lib\net45\Microsoft.AspNet.Razor.dll" />
      </Component>
      <Component Id="Microsoft.AspNet.SignalR.Core">
        <File Id="Microsoft.AspNet.SignalR.Core.dll" Name="Microsoft.AspNet.SignalR.Core.dll" Source="$(var.SolutionDir)Dependencies\NuGet\Microsoft.AspNet.SignalR.Core.2.2.0\lib\net45\Microsoft.AspNet.SignalR.Core.dll" />
      </Component>
      <Component Id="System.Net.Http.Formatting">
        <File Id="System.Net.Http.Formatting.dll" Name="System.Net.Http.Formatting.dll" Source="$(var.SolutionDir)Dependencies\NuGet\Microsoft.AspNet.WebApi.Client.5.2.3\lib\net45\System.Net.Http.Formatting.dll" />
      </Component>
      <Component Id="System.Web.Http">
        <File Id="System.Web.Http.dll" Name="System.Web.Http.dll" Source="$(var.SolutionDir)Dependencies\NuGet\Microsoft.AspNet.WebApi.Core.5.2.3\lib\net45\System.Web.Http.dll" />
      </Component>
      <Component Id="System.Web.Http.Owin">
        <File Id="System.Web.Http.Owin.dll" Name="System.Web.Http.Owin.dll" Source="$(var.SolutionDir)Dependencies\NuGet\Microsoft.AspNet.WebApi.Owin.5.2.3\lib\net45\System.Web.Http.Owin.dll" />
      </Component>
      <Component Id="Microsoft.CodeDom.Providers.DotNetCompilerPlatform">
        <File Id="Microsoft.CodeDom.Providers.DotNetCompilerPlatform.dll" Name="Microsoft.CodeDom.Providers.DotNetCompilerPlatform.dll" Source="$(var.SolutionDir)Dependencies\NuGet\Microsoft.CodeDom.Providers.DotNetCompilerPlatform.1.0.1\lib\net45\Microsoft.CodeDom.Providers.DotNetCompilerPlatform.dll" />
      </Component>
      <Component Id="Microsoft.Owin">
        <File Id="Microsoft.Owin.dll" Name="Microsoft.Owin.dll" Source="$(var.SolutionDir)Dependencies\NuGet\Microsoft.Owin.2.1.0\lib\net45\Microsoft.Owin.dll" />
      </Component>
      <Component Id="Microsoft.Owin.Diagnostics">
        <File Id="Microsoft.Owin.Diagnostics.dll" Name="Microsoft.Owin.Diagnostics.dll" Source="$(var.SolutionDir)Dependencies\NuGet\Microsoft.Owin.Diagnostics.2.1.0\lib\net40\Microsoft.Owin.Diagnostics.dll" />
      </Component>
      <Component Id="Microsoft.Owin.Host.HttpListener">
        <File Id="Microsoft.Owin.Host.HttpListener.dll" Name="Microsoft.Owin.Host.HttpListener.dll" Source="$(var.SolutionDir)Dependencies\NuGet\Microsoft.Owin.Host.HttpListener.3.0.1\lib\net45\Microsoft.Owin.Host.HttpListener.dll" />
      </Component>
      <Component Id="Microsoft.Owin.Hosting">
        <File Id="Microsoft.Owin.Hosting.dll" Name="Microsoft.Owin.Hosting.dll" Source="$(var.SolutionDir)Dependencies\NuGet\Microsoft.Owin.Hosting.2.1.0\lib\net45\Microsoft.Owin.Hosting.dll" />
      </Component>
      <Component Id="Microsoft.Owin.Security">
        <File Id="Microsoft.Owin.Security.dll" Name="Microsoft.Owin.Security.dll" Source="$(var.SolutionDir)Dependencies\NuGet\Microsoft.Owin.Security.2.1.0\lib\net45\Microsoft.Owin.Security.dll" />
      </Component>
      <Component Id="Newtonsoft.Json">
        <File Id="Newtonsoft.Json.dll" Name="Newtonsoft.Json.dll" Source="$(var.SolutionDir)Dependencies\NuGet\Newtonsoft.Json.6.0.4\lib\net45\Newtonsoft.Json.dll" />
      </Component>
      <Component Id="Owin">
        <File Id="Owin.dll" Name="Owin.dll" Source="$(var.SolutionDir)Dependencies\NuGet\Owin.1.0\lib\net40\Owin.dll" />
      </Component>
      <Component Id="RazorEngine">
        <File Id="RazorEngine.dll" Name="RazorEngine.dll" Source="$(var.SolutionDir)Dependencies\NuGet\RazorEngine.3.7.7\lib\net45\RazorEngine.dll" />
      </Component>
      <Component Id="System.Web.Razor">
        <File Id="System.Web.Razor.dll" Name="System.Web.Razor.dll" Source="$(var.SolutionDir)Dependencies\Microsoft\System.Web.Razor.dll" />
      </Component>
      <Component Id="AjaxMin">
        <File Id="AjaxMin.dll" Name="AjaxMin.dll" Source="$(var.SolutionDir)Dependencies\NuGet\AjaxMin.5.14.5506.26202\lib\net40\AjaxMin.dll" />
      </Component>
    </ComponentGroup>
  </Fragment>

  <!-- Custom Dialogs -->
  <Fragment>
    <UI>
      <!-- ServiceAccount Dialog -->
      <Dialog Id="ServiceAccountDialog" Width="370" Height="270" Title="[ProductName] Setup">
        <Control Id="BannerBitmap" Type="Bitmap" X="0" Y="0" Width="370" Height="44" TabSkip="no" Text="WixUI_Bmp_Banner" />
        <Control Id="Title" Type="Text" X="15" Y="6" Width="200" Height="15" Transparent="yes" NoPrefix="yes">
          <Text>{\WixUI_Font_Title}Service Account</Text>
        </Control>
        <Control Id="Description" Type="Text" X="25" Y="23" Width="280" Height="15" Transparent="yes" NoPrefix="yes">
          <Text>Enter the [ProductName] service account.</Text>
        </Control>
        <Control Id="BannerLine" Type="Line" X="0" Y="44" Width="370" Height="0" />
        <Control Id="ServiceAccountLabel" Type="Text" X="45" Y="73" Width="100" Height="15" TabSkip="no" Text="&amp;Service Account:" />
        <Control Id="ServiceAccountEdit" Type="Edit" X="45" Y="85" Width="220" Height="18" Property="SERVICEACCOUNT" Text="{80}" />
        <Control Id="ServicePasswordLabel" Type="Text" X="45" Y="113" Width="100" Height="15" TabSkip="no" Text="&amp;Service Password:" />
        <Control Id="ServicePasswordEdit" Type="Edit" X="45" Y="125" Width="220" Height="18" Property="SERVICEPASSWORD" Text="{80}" Password="yes" />
        <Control Id="ServicePasswordInfo" Type="Text" X="45" Y="153" Width="280" Height="30" Transparent="yes" NoPrefix="yes">
          <Text>NOTE: If the service account is LocalSystem or begins with NT AUTHORITY or NT SERVICE you may leave the password field blank.</Text>
        </Control>
        <Control Id="BottomLine" Type="Line" X="0" Y="234" Width="370" Height="0" />
        <Control Id="Back" Type="PushButton" X="180" Y="243" Width="56" Height="17" Text="&amp;Back">
          <Publish Event="NewDialog" Value="CustomizeDlg">1</Publish>
        </Control>
        <Control Id="Next" Type="PushButton" X="236" Y="243" Width="56" Height="17" Default="yes" Text="&amp;Next">
          <Publish Event="DoAction" Value="AuthenticateServiceAccountAction">1</Publish>
          <Publish Event="NewDialog" Value="ServiceAccountErrorDialog">NOT SERVICEAUTHENTICATED</Publish>
          <Publish Event="NewDialog" Value="CompanyInfoDialog">SERVICEAUTHENTICATED</Publish>
        </Control>
        <Control Id="Cancel" Type="PushButton" X="304" Y="243" Width="56" Height="17" Cancel="yes" Text="Cancel">
          <Publish Event="SpawnDialog" Value="CancelDlg">1</Publish>
        </Control>
      </Dialog>

      <!-- ServiceAccountError Dialog -->
      <Dialog Id="ServiceAccountErrorDialog" Width="370" Height="270" Title="[ProductName] Setup">
        <Control Id="BannerBitmap" Type="Bitmap" X="0" Y="0" Width="370" Height="44" TabSkip="no" Text="WixUI_Bmp_Banner" />
        <Control Id="Title" Type="Text" X="15" Y="6" Width="200" Height="15" Transparent="yes" NoPrefix="yes">
          <Text>{\WixUI_Font_Title}Service Account</Text>
        </Control>
        <Control Id="Description" Type="Text" X="25" Y="23" Width="280" Height="15" Transparent="yes" NoPrefix="yes">
          <Text>Setup encountered an error authenticating the service account.</Text>
        </Control>
        <Control Id="BannerLine" Type="Line" X="0" Y="44" Width="370" Height="0" />
        <Control Id="InfoLabel" Type="Text" X="45" Y="73" Width="280" Height="60" TabSkip="no">
          <Text>The service account entered could not be authorized. The username or password may have been entered incorrectly. To correct this, please click the "Back" button to go back to the previous step. To ignore this error and proceed with the installation, click the "Next" button.</Text>
        </Control>
        <Control Id="BottomLine" Type="Line" X="0" Y="234" Width="370" Height="0" />
        <Control Id="Back" Type="PushButton" X="180" Y="243" Width="56" Height="17" Default="yes" Text="&amp;Back">
          <Publish Event="NewDialog" Value="ServiceAccountDialog">1</Publish>
        </Control>
        <Control Id="Next" Type="PushButton" X="236" Y="243" Width="56" Height="17" Default="yes" Text="&amp;Next">
          <Publish Event="NewDialog" Value="CompanyInfoDialog">1</Publish>
        </Control>
        <Control Id="Cancel" Type="PushButton" X="304" Y="243" Width="56" Height="17" Cancel="yes" Text="Cancel">
          <Publish Event="SpawnDialog" Value="CancelDlg">1</Publish>
        </Control>
      </Dialog>

      <!-- CompanyInfo Dialog -->
      <Dialog Id="CompanyInfoDialog" Width="370" Height="270" Title="[ProductName] Setup">
        <Control Id="BannerBitmap" Type="Bitmap" X="0" Y="0" Width="370" Height="44" TabSkip="no" Text="WixUI_Bmp_Banner" />
        <Control Id="Title" Type="Text" X="15" Y="6" Width="200" Height="15" Transparent="yes" NoPrefix="yes">
          <Text>{\WixUI_Font_Title}Company Information</Text>
        </Control>
        <Control Id="Description" Type="Text" X="25" Y="23" Width="280" Height="15" Transparent="yes" NoPrefix="yes">
          <Text>Enter information for the company using [ProductName].</Text>
        </Control>
        <Control Id="BannerLine" Type="Line" X="0" Y="44" Width="370" Height="0" />
        <Control Id="CompanyNameLabel" Type="Text" X="45" Y="73" Width="100" Height="15" TabSkip="no" Text="&amp;Company Name:" />
        <Control Id="CompanyNameEdit" Type="Edit" X="45" Y="85" Width="220" Height="18" Property="COMPANYNAME" Text="{80}" />
        <Control Id="CompanyAcronymLabel" Type="Text" X="45" Y="113" Width="100" Height="15" TabSkip="no" Text="&amp;Company Acronym:" />
        <Control Id="CompanyAcronymEdit" Type="Edit" X="45" Y="125" Width="220" Height="18" Property="COMPANYACRONYM" Text="{80}" />
        <Control Id="BottomLine" Type="Line" X="0" Y="234" Width="370" Height="0" />
        <Control Id="Back" Type="PushButton" X="180" Y="243" Width="56" Height="17" Text="&amp;Back">
          <Publish Event="NewDialog" Value="ServiceAccountDialog">1</Publish>
        </Control>
        <Control Id="Next" Type="PushButton" X="236" Y="243" Width="56" Height="17" Default="yes" Text="&amp;Next">
          <Publish Event="NewDialog" Value="DatabaseConnectionDialog">1</Publish>
        </Control>
        <Control Id="Cancel" Type="PushButton" X="304" Y="243" Width="56" Height="17" Cancel="yes" Text="Cancel">
          <Publish Event="SpawnDialog" Value="CancelDlg">1</Publish>
        </Control>
      </Dialog>
      
      <!-- Database Connection Dialog -->
      <Dialog Id="DatabaseConnectionDialog" Width="370" Height="270" Title="[ProductName] Setup">
        <Control Id="BannerBitmap" Type="Bitmap" X="0" Y="0" Width="370" Height="44" TabSkip="no" Text="WixUI_Bmp_Banner" />
        <Control Id="Title" Type="Text" X="15" Y="6" Width="200" Height="15" Transparent="yes" NoPrefix="yes">
          <Text>{\WixUI_Font_Title}Database Connection</Text>
        </Control>
        <Control Id="Description" Type="Text" X="25" Y="23" Width="280" Height="15" Transparent="yes" NoPrefix="yes">
          <Text>Configure your database connection.</Text>
        </Control>
        <Control Id="BannerLine" Type="Line" X="0" Y="44" Width="370" Height="0" />
        <Control Id="ServerNameLabel" Type="Text" X="95" Y="53" Width="100" Height="13" TabSkip="no" Text="&amp;Server name:" />
        <Control Id="ServerNameEdit" Type="Edit" X="95" Y="65" Width="170" Height="18" Property="SERVERNAME" Text="{80}" />
        <Control Id="DatabaseNameLabel" Type="Text" X="95" Y="88" Width="100" Height="13" TabSkip="no" Text="&amp;Database name:" />
        <Control Id="DatabaseNameEdit" Type="Edit" X="95" Y="100" Width="170" Height="18" Property="DATABASENAME" Text="{80}" />
        <Control Id="WindowsAuthenticationCheckBox" Type="CheckBox" X="85" Y="125" Width="200" Height="17" Property="WINDOWSAUTH" Text="Use Windows Authentication" />
        <Control Id="UsernameLabel" Type="Text" X="95" Y="143" Width="100" Height="13" TabSkip="no" Text="&amp;Username:">
          <Condition Action="enable">NOT WINDOWSAUTH</Condition>
          <Condition Action="disable">WINDOWSAUTH</Condition>
        </Control>
        <Control Id="UsernameEdit" Type="Edit" X="95" Y="155" Width="170" Height="18" Property="DBUSERNAME" Text="{80}">
          <Condition Action="enable">NOT WINDOWSAUTH</Condition>
          <Condition Action="disable">WINDOWSAUTH</Condition>
        </Control>
        <Control Id="PasswordLabel" Type="Text" X="95" Y="178" Width="100" Height="13" TabSkip="no" Text="&amp;Password:">
          <Condition Action="enable">NOT WINDOWSAUTH</Condition>
          <Condition Action="disable">WINDOWSAUTH</Condition>
        </Control>
        <Control Id="PasswordEdit" Type="Edit" X="95" Y="190" Width="170" Height="18" Property="DBPASSWORD" Text="{80}" Password="yes">
          <Condition Action="enable">NOT WINDOWSAUTH</Condition>
          <Condition Action="disable">WINDOWSAUTH</Condition>
        </Control>
        <Control Id="BottomLine" Type="Line" X="0" Y="234" Width="370" Height="0" />
        <Control Id="Back" Type="PushButton" X="180" Y="243" Width="56" Height="17" Text="&amp;Back">
          <Publish Event="NewDialog" Value="CompanyInfoDialog"><![CDATA[&ServiceFeature=3 OR (!ServiceFeature=3 AND &ServiceFeature=-1)]]></Publish>
          <Publish Event="NewDialog" Value="CustomizeDlg"><![CDATA[NOT(&ServiceFeature=3 OR (!ServiceFeature=3 AND &ServiceFeature=-1))]]></Publish>
        </Control>
        <Control Id="Next" Type="PushButton" X="236" Y="243" Width="56" Height="17" Default="yes" Text="&amp;Next">
          <!-- Set up the queries to create the database. -->
          <Publish Property="GENPASSWORDLENGTH" Value="20">1</Publish>
          <Publish Event="DoAction" Value="PasswordGenerationAction">NOT XDASERVICEPASSWORD</Publish>
          <Publish Property="XDASERVICELOGIN" Value="XDAService">1</Publish>
          <Publish Property="XDASERVICEPASSWORD" Value="[GENERATEDPASSWORD]">NOT XDASERVICEPASSWORD</Publish>
          <Publish Property="CREATEDBQUERY" Value="CREATE DATABASE [\[][DATABASENAME][\]]">1</Publish>
          <Publish Property="ALTERDBQUERY" Value="ALTER DATABASE [\[][DATABASENAME][\]] SET TRUSTWORTHY ON">1</Publish>
          <Publish Property="CREATEDBLOGINQUERY" Value="IF NOT EXISTS (SELECT * FROM master.dbo.syslogins WHERE loginname = '[XDASERVICELOGIN]') CREATE LOGIN [\[][XDASERVICELOGIN][\]] WITH PASSWORD = '[XDASERVICEPASSWORD]', CHECK_EXPIRATION = OFF, CHECK_POLICY = OFF">1</Publish>
          <Publish Property="ALTERDBLOGINQUERY" Value="ALTER LOGIN [\[][XDASERVICELOGIN][\]] WITH PASSWORD = '[XDASERVICEPASSWORD]'">1</Publish>
          <Publish Property="CREATEDBUSERQUERY" Value="CREATE USER [\[][XDASERVICELOGIN][\]] FOR LOGIN [\[][XDASERVICELOGIN][\]]">1</Publish>
          <Publish Property="DBPERMISSIONSQUERY" Value="EXEC sp_addrolemember N'db_owner', N'[XDASERVICELOGIN]'">1</Publish>
          
          <!-- Set up the authentication part of the connection string based on user input. -->
          <Publish Property="AUTHSTRING" Value="Integrated Security=SSPI">WINDOWSAUTH</Publish>
          <Publish Property="AUTHSTRING" Value="User Id=[DBUSERNAME];;Password=[DBPASSWORD]">NOT WINDOWSAUTH</Publish>
          <Publish Property="XDAAUTHSTRING" Value="Integrated Security=SSPI"><![CDATA[NOT(&DatabaseFeature=3 OR (!DatabaseFeature=3 AND &DatabaseFeature=-1))]]> AND WINDOWSAUTH</Publish>
          <Publish Property="XDAAUTHSTRING" Value="User Id=[DBUSERNAME];;Password=[DBPASSWORD]"><![CDATA[NOT(&DatabaseFeature=3 OR (!DatabaseFeature=3 AND &DatabaseFeature=-1))]]> AND NOT WINDOWSAUTH</Publish>
          <Publish Property="XDAAUTHSTRING" Value="User Id=[XDASERVICELOGIN];;Password=[XDASERVICEPASSWORD]"><![CDATA[&DatabaseFeature=3 OR (!DatabaseFeature=3 AND &DatabaseFeature=-1)]]></Publish>
          
          <!-- Set up connection strings for connecting to server and database. -->
          <Publish Property="SERVERCONNECTIONSTRING" Value="Data Source=[SERVERNAME];;[AUTHSTRING]">1</Publish>
          <Publish Property="DBCONNECTIONSTRING" Value="Data Source=[SERVERNAME];;Initial Catalog=[DATABASENAME];;[AUTHSTRING]">1</Publish>
          <Publish Property="XDACONNECTIONSTRING" Value="Data Source=[SERVERNAME];;Initial Catalog=[DATABASENAME];;[XDAAUTHSTRING]">1</Publish>
          
          <!-- Determine whether we can connect to the database server. -->
          <Publish Property="CONNECTIONSTRING" Value="[SERVERCONNECTIONSTRING];;Connection Timeout=5">1</Publish>
          <Publish Event="DoAction" Value="TestDatabaseConnectionAction">1</Publish>
          <Publish Property="DBSERVERCONNECTS">NOT DATABASECONNECTED</Publish>
          <Publish Property="DBSERVERCONNECTS" Value="1">DATABASECONNECTED</Publish>
          <Publish Property="ERRORMESSAGE" Value="Unable to connect to the database. Please verify the connection configuration and try again.">NOT DBSERVERCONNECTS</Publish>
          <Publish Event="SpawnDialog" Value="ModalErrorDialog">NOT DBSERVERCONNECTS</Publish>
          
          <!-- Determine whether the database already exists on the server. -->
          <Publish Property="CONNECTIONSTRING" Value="[DBCONNECTIONSTRING];;Connection Timeout=5">DBSERVERCONNECTS</Publish>
          <Publish Event="DoAction" Value="TestDatabaseConnectionAction">DBSERVERCONNECTS</Publish>
          <Publish Property="DBEXISTS">NOT DATABASECONNECTED</Publish>
          <Publish Property="DBEXISTS" Value="1">DATABASECONNECTED</Publish>
          <Publish Property="ERRORMESSAGE" Value="Database [DATABASENAME] already exists on the server. Enter a different database name or drop the existing database, then try again. If you do not wish to install the database, return to the Custom Setup screen and modify your feature selections."><![CDATA[(&DatabaseFeature=3 OR (!DatabaseFeature=3 AND &DatabaseFeature=-1)) AND DBSERVERCONNECTS AND DBEXISTS]]></Publish>
          <Publish Property="ERRORMESSAGE" Value="Database [DATABASENAME] does not exist on the server. Enter the name of an existing database, then try again. If you wish to install the database, return to the Custom Setup screen and modify your feature selections."><![CDATA[NOT((&DatabaseFeature=3 OR (!DatabaseFeature=3 AND &DatabaseFeature=-1))) AND DBSERVERCONNECTS AND NOT DBEXISTS]]></Publish>
          <Publish Event="SpawnDialog" Value="ModalErrorDialog"><![CDATA[DBSERVERCONNECTS AND (((&DatabaseFeature=3 OR (!DatabaseFeature=3 AND &DatabaseFeature=-1)) AND DBEXISTS) OR (NOT(&DatabaseFeature=3 OR (!DatabaseFeature=3 AND &DatabaseFeature=-1)) AND NOT DBEXISTS))]]></Publish>

          <!-- Move to the next dialog if the validation checks out. -->
          <Publish Event="NewDialog" Value="VerifyReadyDlg"><![CDATA[DBSERVERCONNECTS AND (((&DatabaseFeature=3 OR (!DatabaseFeature=3 AND &DatabaseFeature=-1)) AND NOT DBEXISTS) OR (NOT(&DatabaseFeature=3 OR (!DatabaseFeature=3 AND &DatabaseFeature=-1)) AND DBEXISTS))]]></Publish>
        </Control>
        <Control Id="Cancel" Type="PushButton" X="304" Y="243" Width="56" Height="17" Cancel="yes" Text="Cancel">
          <Publish Event="SpawnDialog" Value="CancelDlg">1</Publish>
        </Control>
      </Dialog>

      <!-- Modal dialog to display error messages. -->
      <Dialog Id="ModalErrorDialog" Width="250" Height="100" Title="Database Connection Error">
        <Control Id="ErrorMessageLabel" Type="Text" X="10" Y="10" Width="230" Height="50" TabSkip="no" Text="[ERRORMESSAGE]" />
        <Control Id="OKButton" Type="PushButton" X="82" Y="70" Width="56" Height="17" Default="yes" Cancel="yes" Text="&amp;OK">
          <Publish Event="EndDialog" Value="Return">1</Publish>
        </Control>
      </Dialog>
    </UI>
  </Fragment>
</Wix>